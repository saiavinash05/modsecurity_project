# ============================================================================
# CUSTOM WAF HARDENING & VIRTUAL PATCHING POLICY
# File: RESPONSE-999-CUSTOM.conf
# ============================================================================

# --- 1. VIRTUAL PATCHING: OS COMMAND INJECTION ---
# Targets specific reconnaissance commands (whoami) used in RCE attempts.
# This prevents an attacker from verifying their current shell privileges.
SecRule ARGS "@contains whoami" \
    "id:10001, \
    phase:2, \
    deny, \
    status:403, \
    log, \
    msg:'VIRTUAL PATCH: Blocked OS Command Injection Recon (whoami detected)', \
    tag:'PROJECT_MITIGATION_1'"

# --- 2. POLICY TUNING: FALSE POSITIVE MANAGEMENT ---
# Specifically targets the setup.php page to ensure administrative tasks
# are not blocked by aggressive SQL Injection (SQLi) CRS rules.
SecRule REQUEST_FILENAME "@endsWith setup.php" \
    "id:10002, \
    phase:2, \
    pass, \
    nolog, \
    ctl:ruleRemoveById=942100, \
    msg:'TUNING: Disabled SQLi check on setup.php to resolve false positive'"

# --- 3. INPUT VALIDATION: POSITIVE SECURITY MODEL ---
# Hardens the 'id' parameter by ensuring it does not contain alphabetic characters.
# Effectively neutralizes SQLi and XSS payloads on this specific field.
SecRule ARGS:id "@rx [a-zA-z]" \
    "id:10003, \
    phase:2, \
    deny, \
    status:403, \
    log, \
    msg:'HARDENING: Numeric field ID contains illegal characters'"

# --- 4. INPUT VALIDATION: XSS MITIGATION ---
# Specifically targets the 'name' parameter to prevent Reflected XSS 
# by blocking the common <script> tag pattern.
SecRule ARGS:name "@rx <script>" \
    "id:10004, \
    phase:2, \
    deny, \
    status:403, \
    log, \
    msg:'HARDENING: Script tag detected in name field'"

# --- 5. PROTOCOL HARDENING: SECURITY HEADERS ---
# These headers instruct the browser to enforce security policies that 
# mitigate client-side attacks like Clickjacking and MIME-sniffing.

# Prevents the site from being rendered in an iframe (Anti-Clickjacking)
Header set X-Frame-Options "DENY"

# Disables MIME-type sniffing to prevent MIME-confusion attacks
Header set X-Content-Type-Options "nosniff"

# Forces the browser to block the page if a reflected XSS attack is detected
Header set X-XSS-Protection "1; mode=block"
